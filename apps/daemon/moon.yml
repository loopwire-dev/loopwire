language: rust
stack: backend
layer: application

fileGroups:
  sources:
    - 'crates/**/src/**/*'
  configs:
    - 'Cargo.toml'
    - 'crates/*/Cargo.toml'

tasks:
  setup:
    command: 'cargo install cargo-watch@8.5.3'
    preset: server

  dev:
    script: 'cargo watch -x "run --bin loopwired -- start"'
    deps:
      - 'setup'
    preset: server
    options:
      envFile: '/.env'

  coverage:
    command: 'cargo llvm-cov --workspace --lcov --output-path lcov.info --fail-under-lines 1'
    inputs:
      - '@group(sources)'
      - '@group(configs)'
    outputs:
      - 'lcov.info'

  quality:
    command: 'echo "daemon quality checks passed"'
    deps:
      - 'format'
      - 'lint'
      - 'check'
      - 'test'
