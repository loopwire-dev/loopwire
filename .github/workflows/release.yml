name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  detect-changes:
    name: Detect Release Changes
    runs-on: ubuntu-latest
    outputs:
      daemon_changed: ${{ steps.changes.outputs.daemon_changed }}
      web_changed: ${{ steps.changes.outputs.web_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: changes
        name: Detect changed areas since previous tag
        shell: bash
        run: |
          set -euo pipefail

          prev_tag="$(git describe --tags --abbrev=0 "${GITHUB_SHA}^" 2>/dev/null || true)"

          if [[ -z "${prev_tag}" ]]; then
            echo "No previous tag found; releasing both daemon and web."
            echo "daemon_changed=true" >> "$GITHUB_OUTPUT"
            echo "web_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed_files="$(git diff --name-only "${prev_tag}" "${GITHUB_SHA}")"
          echo "Previous tag: ${prev_tag}"
          echo "Changed files:"
          echo "${changed_files}"

          daemon_changed=false
          web_changed=false

          if echo "${changed_files}" | grep -Eq '^(apps/daemon/|scripts/install\.sh|\.github/workflows/release\.yml$)'; then
            daemon_changed=true
          fi

          if echo "${changed_files}" | grep -Eq '^(apps/web/|packages/types/|\.github/workflows/release\.yml$)'; then
            web_changed=true
          fi

          echo "daemon_changed=${daemon_changed}" >> "$GITHUB_OUTPUT"
          echo "web_changed=${web_changed}" >> "$GITHUB_OUTPUT"

  build-daemon:
    name: Build Daemon (${{ matrix.target }})
    needs: [detect-changes]
    if: needs.detect-changes.outputs.daemon_changed == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: loopwired-linux-amd64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: loopwired-linux-arm64
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact: loopwired-darwin-amd64
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: loopwired-darwin-arm64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact: loopwired-windows-amd64.exe
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.84.0"
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/daemon

      - name: Build
        working-directory: apps/daemon
        run: cargo build --release --target ${{ matrix.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Rename binary
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp apps/daemon/target/${{ matrix.target }}/release/loopwired.exe ${{ matrix.artifact }}
          else
            cp apps/daemon/target/${{ matrix.target }}/release/loopwired ${{ matrix.artifact }}
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  build-web:
    name: Build Web
    needs: [detect-changes]
    if: needs.detect-changes.outputs.web_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - run: bun install --frozen-lockfile
      - run: bun run build
        working-directory: apps/web

      - uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [detect-changes, build-daemon, build-web]
    if: needs.detect-changes.outputs.daemon_changed == 'true' || needs.detect-changes.outputs.web_changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - id: assets
        name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail

          files=()

          if [[ "${{ needs.detect-changes.outputs.daemon_changed }}" == "true" ]]; then
            if ! find artifacts -type f -name 'loopwired-*' | grep -q .; then
              echo "Expected daemon artifacts but none were found."
              exit 1
            fi

            while IFS= read -r f; do
              files+=("$f")
            done < <(find artifacts -type f -name 'loopwired-*' | sort)

            find artifacts -type f -name 'loopwired-*' -exec shasum -a 256 {} \; | \
              sed 's|  artifacts/[^/]*/||' > artifacts/checksums.sha256
            cat artifacts/checksums.sha256
            files+=("artifacts/checksums.sha256")
          fi

          if [[ "${{ needs.detect-changes.outputs.web_changed }}" == "true" ]]; then
            if [[ ! -d "artifacts/web-dist" ]]; then
              echo "Expected web artifacts but artifacts/web-dist was not found."
              exit 1
            fi
            files+=("artifacts/web-dist/**")
          fi

          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No release assets resolved."
            exit 1
          fi

          {
            echo "paths<<EOF"
            printf '%s\n' "${files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.assets.outputs.paths }}
          generate_release_notes: true
