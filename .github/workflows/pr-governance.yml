name: PR Governance

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-pr-body:
    name: Validate PR Template
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Enforce required PR sections and issue reference
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            const requiredHeadings = [
              "## Summary",
              "## Linked Issue",
              "## Testing",
              "## Checklist",
            ];

            const missingHeadings = requiredHeadings.filter((heading) => !body.includes(heading));

            const hasIssueReference = /(close[sd]?|fix(e[sd])?|resolve[sd]?|refs?)\s+#\d+/i.test(body)
              || /https:\/\/github\.com\/.+\/issues\/\d+/i.test(body);

            const checkedItemCount = (body.match(/- \[x\]/gi) || []).length;

            const errors = [];
            if (missingHeadings.length > 0) {
              errors.push(`Missing required sections: ${missingHeadings.join(", ")}`);
            }
            if (!hasIssueReference) {
              errors.push("Missing issue reference in 'Linked Issue' (example: Closes #123).");
            }
            if (checkedItemCount === 0) {
              errors.push("Checklist has no completed items. Mark what was verified.");
            }

            if (errors.length > 0) {
              core.setFailed(`PR governance checks failed:\n- ${errors.join("\n- ")}`);
            }
