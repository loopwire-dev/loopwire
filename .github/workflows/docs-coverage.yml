name: Docs Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  docs-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check in-code documentation coverage
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t source_files < <(
            find apps packages -type f \( \
              -name "*.rs" -o -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \
            \) \
              -not -path "*/node_modules/*" \
              -not -path "*/dist/*" \
              -not -path "*/coverage/*" \
              -not -path "*/target/*" \
              -not -path "*/generated/*" \
              -not -name "*.test.ts" \
              -not -name "*.test.tsx" \
              -not -name "*.spec.ts" \
              -not -name "*.spec.tsx" \
              | sort
          )

          total=${#source_files[@]}
          documented=0
          undocumented=()

          for file in "${source_files[@]}"; do
            if grep -Eq '(^[[:space:]]*///|^[[:space:]]*//!|/\*\*)' "$file"; then
              documented=$((documented + 1))
            else
              undocumented+=("$file")
            fi
          done

          if (( total == 0 )); then
            echo "No source files found for docs coverage."
            exit 1
          fi

          coverage=$(( documented * 100 / total ))
          echo "Docs coverage: ${documented}/${total} (${coverage}%)"

          {
            echo "## Docs Coverage"
            echo ""
            echo "- In-code docs coverage: **${documented}/${total} (${coverage}%)**"
            if (( ${#undocumented[@]} > 0 )); then
              echo ""
              echo "### Undocumented Source Files (first 50)"
              for item in "${undocumented[@]:0:50}"; do
                echo "- \`${item}\`"
              done
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # Require baseline in-code documentation coverage.
          if (( coverage < 10 )); then
            echo "In-code docs coverage below required threshold (10%)."
            exit 1
          fi
